name: CD Pipeline - Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Build and Push to Staging
  build-staging:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push backend (staging)
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:staging
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Build and push frontend (staging)
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:staging
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VITE_API_URL=${{ secrets.STAGING_API_URL }}

  # Deploy to Staging Environment
  deploy-staging:
    runs-on: ubuntu-latest
    needs: build-staging
    environment:
      name: staging
      url: https://staging.your-domain.com
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    - name: Deploy to staging ECS
      run: |
        aws ecs update-service \
          --cluster job-portal-staging-cluster \
          --service job-portal-backend-staging \
          --force-new-deployment
        
        aws ecs update-service \
          --cluster job-portal-staging-cluster \
          --service job-portal-frontend-staging \
          --force-new-deployment
    
    - name: Wait for staging deployment
      run: |
        aws ecs wait services-stable \
          --cluster job-portal-staging-cluster \
          --services job-portal-backend-staging job-portal-frontend-staging
    
    - name: Verify staging deployment
      run: |
        curl -f ${{ secrets.STAGING_API_URL }}/api/health || exit 1

  # Integration Tests on Staging
  integration-tests:
    runs-on: ubuntu-latest
    needs: deploy-staging
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Install dependencies
      run: |
        cd backend
        npm ci
    
    - name: Run integration tests
      run: |
        cd backend
        npm run test:integration --if-present
      env:
        API_URL: ${{ secrets.STAGING_API_URL }}
        TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
        TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: backend/test-results/

  # E2E Tests with Playwright
  e2e-tests:
    runs-on: ubuntu-latest
    needs: deploy-staging
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
        npx playwright install --with-deps
    
    - name: Run E2E tests
      run: |
        cd frontend
        npm run test:e2e --if-present
      env:
        BASE_URL: ${{ secrets.STAGING_FRONTEND_URL }}
    
    - name: Upload E2E test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-results
        path: |
          frontend/test-results/
          frontend/playwright-report/

  # Performance Tests
  performance-tests:
    runs-on: ubuntu-latest
    needs: deploy-staging
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Lighthouse CI
      uses: treosh/lighthouse-ci-action@v10
      with:
        urls: |
          ${{ secrets.STAGING_FRONTEND_URL }}
          ${{ secrets.STAGING_FRONTEND_URL }}/login
          ${{ secrets.STAGING_FRONTEND_URL }}/jobs
        uploadArtifacts: true
        temporaryPublicStorage: true
    
    - name: Run k6 load tests
      uses: grafana/k6-action@v0.3.1
      with:
        filename: tests/load-tests.js
        flags: --out json=load-test-results.json
      env:
        K6_CLOUD_TOKEN: ${{ secrets.K6_CLOUD_TOKEN }}
        API_URL: ${{ secrets.STAGING_API_URL }}
    
    - name: Upload load test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: load-test-results
        path: load-test-results.json

  # Notify on Success
  notify-success:
    runs-on: ubuntu-latest
    needs: [integration-tests, e2e-tests, performance-tests]
    if: success()
    
    steps:
    - name: Notify Slack
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            text: "âœ… Staging deployment successful!",
            attachments: [{
              color: 'good',
              text: `Branch: ${process.env.AS_REF}\nCommit: ${process.env.AS_COMMIT}\nAuthor: ${process.env.AS_AUTHOR}\nURL: ${{ secrets.STAGING_FRONTEND_URL }}`
            }]
          }
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
