name: CD Pipeline - Production

on:
  # Temporarily disabled - requires AWS setup
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Build and Push Docker Images
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    outputs:
      backend-tag: ${{ steps.meta-backend.outputs.tags }}
      frontend-tag: ${{ steps.meta-frontend.outputs.tags }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract backend metadata
      id: meta-backend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha
    
    - name: Build and push backend
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        push: true
        tags: ${{ steps.meta-backend.outputs.tags }}
        labels: ${{ steps.meta-backend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Extract frontend metadata
      id: meta-frontend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha
    
    - name: Build and push frontend
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        push: true
        tags: ${{ steps.meta-frontend.outputs.tags }}
        labels: ${{ steps.meta-frontend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VITE_API_URL=${{ secrets.PRODUCTION_API_URL }}

  # Deploy to Production
  deploy-production:
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: production
      url: https://your-domain.com
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    - name: Deploy to ECS
      run: |
        # Update ECS service with new task definition
        aws ecs update-service \
          --cluster job-portal-cluster \
          --service job-portal-backend \
          --force-new-deployment
        
        aws ecs update-service \
          --cluster job-portal-cluster \
          --service job-portal-frontend \
          --force-new-deployment
    
    - name: Wait for deployment
      run: |
        aws ecs wait services-stable \
          --cluster job-portal-cluster \
          --services job-portal-backend job-portal-frontend
    
    - name: Verify deployment
      run: |
        curl -f ${{ secrets.PRODUCTION_API_URL }}/api/health || exit 1

  # Deploy to Heroku (Alternative)
  deploy-heroku:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy backend to Heroku
      uses: akhileshns/heroku-deploy@v3.12.14
      with:
        heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
        heroku_app_name: ${{ secrets.HEROKU_BACKEND_APP }}
        heroku_email: ${{ secrets.HEROKU_EMAIL }}
        appdir: backend
        healthcheck: "https://${{ secrets.HEROKU_BACKEND_APP }}.herokuapp.com/api/health"
        rollbackonhealthcheckfailed: true
    
    - name: Deploy frontend to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'
        working-directory: ./frontend

  # Database Migration
  run-migrations:
    runs-on: ubuntu-latest
    needs: deploy-production
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Install dependencies
      run: |
        cd backend
        npm ci
    
    - name: Run database migrations
      run: |
        cd backend
        npm run migrate --if-present
      env:
        MONGO_URI: ${{ secrets.PRODUCTION_MONGO_URI }}
        NODE_ENV: production

  # Smoke Tests
  smoke-tests:
    runs-on: ubuntu-latest
    needs: deploy-production
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Install dependencies
      run: npm install -g newman
    
    - name: Run smoke tests
      run: |
        newman run tests/smoke-tests.postman_collection.json \
          --environment tests/production.postman_environment.json \
          --reporters cli,json \
          --reporter-json-export smoke-test-results.json
      continue-on-error: true
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: smoke-test-results
        path: smoke-test-results.json

  # Rollback on failure
  rollback:
    runs-on: ubuntu-latest
    needs: [deploy-production, smoke-tests]
    if: failure()
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    - name: Rollback deployment
      run: |
        echo "Rolling back to previous deployment..."
        aws ecs update-service \
          --cluster job-portal-cluster \
          --service job-portal-backend \
          --task-definition job-portal-backend:$(($PREVIOUS_REVISION))
        
        aws ecs update-service \
          --cluster job-portal-cluster \
          --service job-portal-frontend \
          --task-definition job-portal-frontend:$(($PREVIOUS_REVISION))
    
    - name: Notify team
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: 'Production deployment failed and was rolled back'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
